import codecs, json, six

cat = '5178a30001000000ff5178a40001003399ff5178a6000b00aa551738445f5f5f44382ca1ff5178af000200e02e89ff5178be0001000000ff5178bd0001001e5aff5178bf0007007f7f4a81018135fcff5178bf0007007f7f468601823325ff5178bf000f007f7f4383018101810181018101823184ff5178bf000f007f7f418101810182058101810181316eff5178bf000f007f7f4081018201810281018104842fbfff5178bf0013007f7f3e8401810281028102810181018101812f91ff5178bf0013007f7f3c8201810281038201810181038101832e44ff5178bf001b007f7f3a82018201810281018101810181028101810181018101812d25ff5178bf0027007f14810181018101810181018101810281028102817f0f8101820281028101810482058201812e43ff5178a20030000000000000000000000000000000000000a05755db7e0100000000000000000000000000000060c528ab0700000000007dff5178bf0030007f09810183018101810281038103810381058108810184018101817b820182018102820381068101810381018101812d39ff5178a200300000000000000000000000000000000000700322228a0ab00b0000000000000000000000000000344c48d502000000000060ff5178a2003000000000000000000000000000000000808e409494505045f41700000000000000000000000000960a21a3070000000000efff5178a20030000000000000000000000000000000006821002121858a0809e802000000000000000000000000952204550500000000007eff5178a20030000000000000000000000000000000005b00004a4a282452a2120d0000000000000000000000804b8948a305000000000012ff5178a20030000000000000000000000000000000a00a008010114591848844750100000000000000000000c0a22202d50600000000006eff5178a200300000000000000000000000000000005801000022448844525208480500000000000000000000b0548850ab050000000000e2ff5178a2003000000000000000000000000000000016000000949252928804a5923e000000000000000000005031010265030000000000c4ff5178a20030000000000000000000000000000080050000004024044922529244e8030000000000000000002c2a54a8aa050000000000b4ff5178a20030000000000000000000000000000060010000008888528494884812211d000000000000000000549900017303000000000022ff5178a200300000000000000000000000000000580000000020258950205122484aea0100000000000000008b041294d602000000000062ff5178a200300000000000000000000000000000160000000000482425150a892291500f000000000000000055ae48415303000000000006ff5178a20030000000000000000000000000008005000000000022918848a12449444a35000000000000008005050284ea0200000000008fff5178a200300000000000000000000000000040010000000000884412210a922429046d01000000000000c0a82250d0590100000000002bff5178a2003000000000000000000000000000700000000000002012498a5021128252d002000000000000a0028b0285ea0200000000005cff5178a20030000000000000000000000000002c000000000000804824518a44482921551b000000000000b0d40248d05a010000000000c7ff5178a200300000000000000000000000000015000000000000009242841080224294402d00000000000050a0511141e9000000000000e1ff5178a2003000000000000000000000000040030000000000000040282925014494222ada00000000000018550404d45a01000000000001ff5178a20030000000000000000000000000a00000000000000000000242000029214491b0050000000000a4c890a0a0b400000000000095ff5178a20030000000000000000000000000d800000000aa02000000001000008094280a400b00000000000ca5020a6aed000000000000a4ff5178a2003000000000000000000000000014000000a000a800000000000000202185a0005d0000000000a4b0a8a0a05a000000000000c8ff5178a200300000000000000000000000000b00000004000002000000000000004a281500a800000000004a2a0202d2b600000000000034ff5178a20030000000000000000000000080060000000100000c000000000000001045000070030000000013699028686a00000000000051ff5178bf002f00568101813b8241810481038116820182238101810381038101820381018106810581018102810181018101830181312fff5178bf00290055833d8101816082018122810181028102810181028101810681018105810681018202810181018231a6ff5178bf002b0053820181408101815f851e8302810281048101820181018107810181038102810282018101820181018230daff5178bf002d0053810181428101816081018419820181018102810281018102810181058101810781038102810181038101833242ff5178bf002d00528201814381018161810181018315810182038102810481018302810681018105810482018201810181018330d2ff5178a20030000000000000000000000016000000000000000014000000000000000000000000f50ad447a42a2514322e000000000000ecff5178a2003000000000000000000000000b000000000000000058000000000000000000000000a8edbb2811f4daeb58f9000000000000b4ff5178a200300000000000000000000080020000000000000000a0000000000000000000000000005a55854481b6b6ab56000000000000b8ff5178bf002d004e834c8201817081098101810281028101810381018101810281028104810281028101810184038101820181319cff5178bf002b004e8101814e810181738101810181048103810481048102810581018104810381018103810282018201813046ff5178bf002b004d825082018175810281018102810381018102810181058101810481018102810381028102810282018231f8ff5178bf002b004c810182508274810281048102810581048101810181038101810481028101810281028102810182018230aeff5178bf002b004c825383738102810181038102810181028101810481028104810181028105810281028101810182018130abff5178bf002b004b81018154810181738104810381028102810381018103810281018103810381018103810481018201813170ff5178bf0029004b82018153837581018102810281028103810481018102810381038103810281038101810181018430d4ff5178bf0029004a81018155810182728104810281058103810181058102810281018102810281028102810481028131a5ff5178bf002d0049835781018273810181028102810181028101810381018101810481048102810381028102810381018101812f6bff5178bf0025004981018157820181768103810381048103810481018102810181028102810381048107822d74ff5178bf002b00488201810181568201817381038103810281018102810181028101810381048103810281038101810a812c39ff5178bf0021004781018259810182788101810281038105810381038101810381038102810f812b1bff5178bf00290047820181018101815581018101817a81038103810181038102810181038101810281028102810e822a5bff5178bf001d0046810181068155837d810281018103810181028104810481028115812924ff5178bf0020004683018101810181568101827f0381018103810381018102810381038113822801ff5178bf001d004582018102810481548201827f8105810381048102810181028116822711ff5178bf002000448201810281028101815581018101817f058102810281018102811d81018126aeff5178bf00120043810182028102810481538201827f2f8325f6ff5178bf00120043820181038103810181558201817f31812523ff5178bf0019004281018102810181028158810182018120810381118178832322ff5178bf0025004181018201810481028101810181538201821c8101810281018103810c81038176810181236fff5178bf0023004182018102810181038103815381018201811a810481058103810b81018102817583221eff5178bf002900408101820181048101810281568101821a810281018102810181028101810281078104817781018122faff5178bf0029003e82018101810381018104810281538301821881028103810481048102810781018103812a814b8321beff5178bf002b003c8202830281058101810281028152810181018117810481038101810281018102810c812c814c81018220c3ff5178bf002b003b81028201810181028101810181048155810183018118810181028104810481038108810281798101812081ff5178a2003000000000000000008a1552020000000000000000006005000025292501000000000040000000000000000000e001000000adff5178bf002900388101810181018101820381018103810481558201821881038102810381058102815181348101811f81ff5178bf002f003681018104810181018205810181028103815381018201811481018102810481028103810181038137814f8201811ef5ff5178a2003000000000000000a0caa99004000000000000000000d006000049a12800000000000020000000000000000000400300000006ff5178a20030000000000000005aa41245020000000000000000006005004024140500000000000040000000000000000000800500000039ff5178a20030000000000000808568452801000000000000000000d003008042491000000000000020000010000000000000800b00000034ff5178a200300000000000006029459182040000000000000000006801002028b205000000010000200000000800000000008006000000c1ff5178bf002f002b8202810281038105810281028102810481018101815482018101821481018101810481028223811d81518201811d9cff5178a2003000000000000027924a482101000000000000000000e800001028130000004000000010000040100400000000800e000000f0ff5178a200300000000000c0940824058a04000000000000000000b4010040c502000000200000003000000000000000000040150000003cff5178a200300000000000502151115211010000000000000000006c00009068000000001000000020000000200400000000201b000000fbff5178a2003000000000002c8a844491a400000000000000000000da0000209a000000002800000010000000010000000000400d0000000aff5178a2003000000000004b515292241202000000000000000000b600004815000000000c00000018000000000480000000101b000000aeff5178a2003000000000e0120289488848010000000000000000002d0000100a0000000002000000300000004008000100004836000000f8ff5178a20030000000002849a910252505000000000000000000007500004007000000000300000008000000020800010000202d00000017ff5178a20030000000005684444a104250010000000000000000802e00008001000000c00000000018000000400800060000941a00000099ff5178a2003000000000855028244529250000000000000000008015000040010000004001000000300000000408000a0000403600000058ff5178a20030000000c029258542288488000000000000000000401b0000e000000000600000000008000000801000040000142d000000a4ff5178a200300000005092885028455112000000000000000000e0160000a0000000045800000000380000000809000c0000487a0000007bff5178a20030000000a844128542080a49000000000000000000a00d000030000000103400000000100000000011001c00002215000000acff5178a20030000000541249289452a1100000000000000000005003000028000000400f0000000028000000101200140000946e00000021ff5178a200300000008e4824452184140a0000000000000000007805000018000000800a000000003000000010120038000040b4000000daff5178a20030000080129142889452a304000000000000000000a40500002c000000000a00000000500000002000002c0000156d010000bdff5178a20030000040a524282522c41601000000000000000000dc0200001400000000180000000020000000000400380000485a070000e0ff5178a200300000c04292424889b245020000000000000000006a0100000e0000000020000000004000000040000028000092b61c000077ff5178a200300000b02844941224ad2a040000000000000000005d0000000a00000000600000000000000000800000380000446c70000008ff5178a200300000509212214449c58502000000000000000080b60000000b00000000c000000000000000000001003c00001155a503000cff5178a2003000002c09a19412d24257000000000000000000805500000006000000008001000000000000000000002c0000a42892060082ff5178a20030000094a4142248b5808a000000000000000000402f00000005000000000007000000000000000000003a00001242491d008aff5178a2003000002a424889222dc015000000000000000000e00a0000000300000000000a000000000000000000002e00004429046a002bff5178a20030000046280552941a8026000000000000000000500b0000800600000000001600000000000000000000180000129252d90189ff5178a20030000095825081a207800d000000000000000000b8050000000300000000002c00000000000000000000000000480988b00237ff5178a20030008022548a54a8008006000000000000000000d402000080060000000000580000000000000000000000000024e452a205daff5178a20030008095225008d500001d000000000000000000b6000000800200000000007001000000000000000000000000905a97a40b2aff5178a20030004009890aa52800000b0000000000000000006d00000080050000000000d0000000000000000000000000000801744b16d0ff5178a2003000a0a250a4081d00001d000000000000002a001b00000000030000000000a003002800000000000000000000a0ac80b61d0fff5178a200300060498a02510600002b0000000000000000555552bb00bd060000000000600580f70b00000000000000000008094aa86aa4ff5178a2003000a02424a8840500005a000000000000000080aeadd6d7c2050000000000400b700515000000000000000000a09400d13777ff5178a200300050824245520300003600000000000000000050db555a000b0000000000c006d4526e000000000000000000400a52446d96ff5178a2003000b0282928a40200002c000000000000000000002088b401050000000000801d5a89d800000020000000000000550051554aff5178a200300050929082d201000034000000000000000000008a2269070f0000000000002b1723b5000000000000000000400c556c5f35ff5178a200300028490a29a40000006c000000000000000000005194c40a0a000000000080d6aa4a68030000200000080000001480da2aaeff5178a20030005804a144b1000000b400000000000000000040842052171a000000000000bd1525d102000020002010000000a46ab70232ff5178a200300094501492d40000006800000000000000000080528a881a2c0000000000006b238dd40500002000c062002a000cb505004eff5178a20030002c25a148b2000000d8010000000000000000500851a26d18000000000000ad442aa10200002000200180ff01f42e0000b4ff5178a20030009488141169000000b000000000000000000004a524091b68000000000000da295d6a07000020004005c0400fae0100001cff5178a20030002c52424a54000000d0030000000000000000a81092a476b0000000000000b64254d00a0000c000a00a20800a08000000fbff5178a20030008a0429217100000060050000000000000000424a4949ad600100000000006829b94a070000800150150000000c0000000fff5178a200300056524414aa00000040030000000000000000292004135a40010000000000dc42d2a20d0000000302290000000c00000043ff5178a20030008a88124171000000c00e0000000000000000848a52a2b680030000000000302bb4a90a000000fc0d000000000a000000a6ff5178a20030001611482aaa000000801a00000000000000805224880e6d080e00000000006c8a6263070000000005000000001c0000001dff5178a20030004da22291d0000000002b0000000000000000849222aa5a18140000000000589688ca0a0000000004000000000a00000050ff5178a20030008a144944aa010000005d00000000000000405148940ab5102c0000000000a85412501700000000020000000014000000bfff5178a200300057a2248960010000006a000000000000008084222156af183800000000005c1aa1ca0a0000000001000000000e00000009ff5178a20030008a0812528a06000000b4010000000000002052444a0d5a28d70000000000686814510700000000010000000014000000ddff5178a20030002d52412192be020000d00200000000000080242924fa6a186a0100000000b4d222e20a0000008001000000002e0000007dff5178a20030009604949448d0160000a00f000000000000200982925637b4cd03000000006ca449a9050000008001000000001500000060ff5178a20030004d5249442225f50200803a00000000000040a428a9ad2d680b06000000005889125207000000800100000000070000005dff5178a20030001a2112118988881600006a0000000000009010a5765b5adc0215000000003422a4f4020000004001000000800a0000003fff5178a20030005494444a242251740100dc010000000000404ad8ad0210b4012c00000000d44809a902000000c001000000c00500000012ff5178a20030002c49929092148ac20a00500700000000001091b70a004457005800000000b812a2d405000000000b0000004203000000a8ff5178a200300058222145484221145500c03a0000000000406aada6aaba1500e001000000d4a414bd000000000005000000b800000000adff5178a20030006889142811294aa1b40000ed010000000080d60ad8b65700004007000080bb02a156ab0200000000000000d00100000001ff5178a2003000b02448854444100ac90300500500000000f0bd010000000000801a000040d5aad4edda5d000000000000006e0600000029ff5178a20030006049852892884a51220e00400b00000000ad0200000000000000b60000b0ad55aa1aa06a2b0000000000a015280000007fff5178a2003000c023504249522484881a00005a000000fdb608000000000000006817006d83ae7d070090deaf000000005017800000005bff5178a200300040958a142409915212740000a00542f4aa05000000000000000080ed7fdb0278ab010000407505000000b6010005000056ff5178a2003000802624a282a4440849a9000080fabdaf1500000000000000000000b4d2b600805600000000407b0f00e06d0d00040000dfff5178a2003000009d92082802895224da00000020a548000000000000000000000040ad4d0000000000000000d4faff5f1b5000500000aaff5178a2003000007421a592a82484426101000000000000000000000000000000000010020000000000000000004155b5244000800000f4ff5178a200300000504b884412915228d4000000000000000000000000000000000000000000000000000000000000000000000300010010ff5178a200300000a0beb72a49240485b20100000000000000000000000000000000000000000000000000000000000000400004000000d9ff5178a200300000806a6dd722495128640300000000000000000000000000000000000000000000000000000000000000800018000000beff5178a20030000000d0daba2e228a42d102000000000000000000000000000000000000000000000000000000000000000001c000000060ff5178bf0029001e8101830181018301810185028103810481018103810181048101810181018101817f7f08810e8217dcff5178bf002100288101820181018101820181018102810181048104810181058201817f7f0a81269bff5178bf0023002c81018201810182018101810481018102810181038101810181018201817f7f0a812508ff5178bf0019002f840182018101810181048104810181038301827f7f0c8124a5ff5178bf001b00338101840181018101810281018104810181018101817f7f0e81245bff5178bf00190034810382018201810181018101820182018201827f7f0f812330ff5178bf00130039820182018201820182018201827f7f11812349ff5178bf000f003d8201820182018201817f7f158122d7ff5178bf00050042817f7f3fd7ff5178bd000100194fff5178a10002003000f9ff5178a10002003000f9ff5178bd000100194fff5178a6000b00aa5517000000000000001711ff5178a30001000000ff'

def size(s):
    return len(s)/2

cat_size = size(cat)

# print('Cat size: {} kB ({} bits)'.format(cat_size/8000, cat_size))

# print(bytes.fromhex(cat))
# print(codecs.decode(cat, "hex").decode('utf-8'))


# with open('/tmp/cat_json.json') as j_file:
#     cat_json = json.load(j_file)

# values_dots = [val['_source']['layers']['btatt']['btatt.value'] for val in cat_json]
# values_str = ''.join([x for x in values_dots]).replace(':', '')

# print(values_str == cat)

# print(cat_json[0]['_source']['layers']['btatt']['btatt.value'])


GS  = b'\x1d'

def my_raw(self, msg):
    return self.out_ep, msg, self.timeout

def my_init(self, idVendor, idProduct, usb_args=None, timeout=0, in_ep=0x82, out_ep=0x01, *args, **kwargs):
    Escpos.__init__(self, *args, **kwargs)
    self.timeout = timeout
    self.in_ep = in_ep
    self.out_ep = out_ep

    usb_args = usb_args or {}
    if idVendor:
        usb_args['idVendor'] = idVendor
    if idProduct:
        usb_args['idProduct'] = idProduct

def my_image(self, img_source, high_density_vertical=True, high_density_horizontal=True, impl="bitImageRaster", fragment_height=9600, center=False):
    im = EscposImage(img_source)
    try:
        max_width = 10

        if center:
            im.center(max_width)
    except KeyError:
        # If the printer's pixel width is not known, print anyways...
        pass
    except ValueError:
        # If the max_width cannot be converted to an int, print anyways...
        pass

    if im.height > fragment_height:
        fragments = im.split(fragment_height)
        for fragment in fragments:
            self.image(fragment,
                       high_density_vertical=high_density_vertical,
                       high_density_horizontal=high_density_horizontal,
                       impl=impl,
                       fragment_height=fragment_height)
        return

    if impl == "bitImageRaster":
        # GS v 0, raster format bit image
        density_byte = (0 if high_density_horizontal else 1) + (0 if high_density_vertical else 2)
        header = GS + b"v0" + six.int2byte(density_byte) + self._int_low_high(im.width_bytes, 2) +\
            self._int_low_high(im.height, 2)
        return self._raw(header + im.to_raster_format())

    if impl == "graphics":
        # GS ( L raster format graphics
        img_header = self._int_low_high(im.width, 2) + self._int_low_high(im.height, 2)
        tone = b'0'
        colors = b'1'
        ym = six.int2byte(1 if high_density_vertical else 2)
        xm = six.int2byte(1 if high_density_horizontal else 2)
        header = tone + xm + ym + colors + img_header
        raster_data = im.to_raster_format()
        self._image_send_graphics_data(b'0', b'p', header + raster_data)
        self._image_send_graphics_data(b'0', b'2', b'')

    if impl == "bitImageColumn":
        # ESC *, column format bit image
        density_byte = (1 if high_density_horizontal else 0) + (32 if high_density_vertical else 0)
        header = ESC + b"*" + six.int2byte(density_byte) + self._int_low_high(im.width, 2)
        outp = [ESC + b"3" + six.int2byte(16)]  # Adjust line-feed size
        for blob in im.to_column_format(high_density_vertical):
            outp.append(header + blob + b"\n")
        outp.append(ESC + b"2")  # Reset line-feed size
        return self._raw(b''.join(outp))


# myUsb = Usb
# myUsb.__init__ = my_init
# myUsb.image = my_image
# myUsb._raw = my_raw


# p = Usb(0x04b8, 0x0202, 0)
# # # p.text("Hello World\n")
# res = p.image("/home/lisp3r/Downloads/trees-1614372523737-4703.jpg")
# print(res[1][:20].hex())

# dummy = Dummy()
# # dummy.text('JJJJ!!!')
# dummy.image("/home/lisp3r/Downloads/trees-1614372523737-4703.jpg")
# print(dummy.output[:20].hex())


from bluepy import btle


printer_mac_addp = 'B7:26:A2:0D:CA:66'


class NotifyHandler(btle.DefaultDelegate):
    def __init__(self, params=None):
        std.debug('Initialize notification handler')
        btle.DefaultDelegate.__init__(self)

    def handleNotification(self, cHandle, data):
        std.debug('Got ntification')
        print(cHandle)
        print(data)


# todo: singleton
class STD():
    def __str(self, msg, type):
        print('[{}] {}'.format(type, msg))

    def debug(self, msg):
        self.__str(msg, 'D')

    def info(self, msg):
        self.__str(msg, 'I')

    def warn(self, msg):
        self.__str(msg, 'W')

    def err(self, msg):
        self.__str(msg, 'E')


std = STD()


def get_all_services(printer):
    services = []
    _services = printer.getServices()
    for _s in _services:
        if s := printer.getServiceByUUID(s.uuid.getCommonName()):
            services.append(s)

    return services


def init_item(s):
    if not s.uuid.commonName:
        s.uuid.commonName = s.uuid.getCommonName()
    if hasattr(s, 'chars') and not s.chars:
        s.getCharacteristics()
        for ch in s.chars:
            init_item(ch)
    if hasattr(s, 'descs') and not s.descs:
        s.getDescriptors()
        for d in s.descs:
            init_item(d)


try:
    std.info('Trying to connected to {}...'.format(printer_mac_addp))
    printer = btle.Peripheral(deviceAddr=printer_mac_addp)
    std.info('Connected to {}'.format(printer_mac_addp))
except btle.BTLEDisconnectError as err:
    std.err(err)
    exit(1)

try:
    std.info('Searching for "ae30" service...')
    ae30_service = printer.getServiceByUUID('ae30')
except btle.BTLEEException:
    std.err('Can not find service with UUID ae30')
    std.warn('Services: {}'.format(str(get_all_services(printer))))
    exit(1)

init_item(ae30_service)

msg = 'Found service ae30 with characteristics:\n\n'
for ch in ae30_service.chars:
    msg += '    Characteristic 0x{} ({})\n'.format(ch.uuid.getCommonName().upper(), ch.propertiesToString())
    if ch.descs:
        msg += '        Characteristic Configuration:\n'
        msg += ''.join(['        UUID: {}, Handle: {}\n'.format(x.uuid, x.handle) for x in ch.descs])

std.info(msg)

printer.setDelegate(NotifyHandler)

ae02_char = [ch for ch in ae30_service.chars if ch.uuid.getCommonName() == 'ae02']
if ae02_char:
    ae02_char = ae02_char[0]
else:
    std.err('No characteristic with UUID "ae02"')

# notification_data = b"0100"


print(ae02_char.descs[0].__dict__)
# print(ae02_char.descs[0].write(notification_data))

# std.info('Turning on notifications from ae02 characteristic')

# ae02_char.write(notification_data)

# while True:
#     if printer.waitForNotifications(1.0):
#         continue

#     print ("Waiting...")
    # Perhaps do something else here

# Handle: 0x0009 (Unknown: Unknown: Client Characteristic Configuration)
#     [Service UUID: Unknown (0xae30)]
#     [Characteristic UUID: Unknown (0xae02)]
#     [UUID: Client Characteristic Configuration (0x2902)]
#     Characteristic Configuration Client: 0x0001, Notification
#         0000 0000 0000 00.. = Reseved: 0x0000
#         .... .... .... ..0. = Indication: False
#         .... .... .... ...1 = Notification: True

# Setup to turn notifications on, e.g.
#   svc = p.getServiceByUUID( service_uuid )
#   ch = svc.getCharacteristics( char_uuid )[0]
#   ch.write( setup_data )

std.info('Disonnected from {}'.format(printer_mac_addp))
printer.disconnect()

# std.info('Trying to read from aeo2')

# for ch in ae30.chars:
#     try:
#         if ch.supportsRead():
#             std.info('{} supports read. Trying...'.format(ch.uuid))
#             print(ch.read())
#     except btle.BTLEInternalError as err:
#         std.err(err)
